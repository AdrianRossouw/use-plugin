<!DOCTYPE html>

<html>
<head>
  <title>use.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>use.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* Copyright (c) 2014 Richard Rodger, MIT License */</span>
<span class="hljs-comment">/* jshint node:true, asi:true, eqnull:true */</span>
<span class="hljs-pi">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h4 id="system-modules">System modules</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h4 id="external-modules">External modules</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> _     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
<span class="hljs-keyword">var</span> nid   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nid'</span>)
<span class="hljs-keyword">var</span> norma = <span class="hljs-built_in">require</span>(<span class="hljs-string">'norma'</span>)
<span class="hljs-keyword">var</span> error = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eraro'</span>)({package:<span class="hljs-string">'use-plugin'</span>})</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4 id="create-a-new-_use_-function">Create a new <em>use</em> function</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make</span><span class="hljs-params">( options )</span> {</span>

  options = _.extend({
    prefix:<span class="hljs-string">'plugin-'</span>
  },options)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>This is the function that loads plugins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">use</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args        = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> parent      = module.parent
    <span class="hljs-keyword">var</span> grandparent = parent.parent
    
    args.unshift(grandparent)
    args.unshift(options)

    <span class="hljs-keyword">var</span> plugindesc = build_plugindesc.apply( <span class="hljs-literal">null</span>, args )
    resolve_plugin( plugindesc, parent, options )

    <span class="hljs-keyword">return</span> plugindesc
  }

  
  <span class="hljs-keyword">return</span> use;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h4 id="create-description-object-for-the-plugin-using-the-supplied-arguments">Create description object for the plugin using the supplied arguments</h4>
<p>Plugin can be one of:</p>
<ul>
<li><em>string</em>: require as a module over an extended range of paths</li>
<li><em>function</em>: provide the initialization function directly</li>
<li><em>object</em>: provide a custom plugin description</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build_plugindesc</span><span class="hljs-params">( baseoptions, parent )</span> {</span>
  <span class="hljs-keyword">var</span> spec = norma(<span class="hljs-string">"{plugin:o|f|s, options:o|s|n|b?, callback:f? "</span>,<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">2</span>))

  <span class="hljs-keyword">var</span> plugin = spec.plugin

  <span class="hljs-keyword">var</span> options = <span class="hljs-literal">null</span> == spec.options ? {} : spec.options
  options = _.isObject(options) ? options : {value$:options}
  options = _.extend({},baseoptions,options)


  <span class="hljs-keyword">var</span> plugindesc = {
    options:  options,
    callback: spec.callback,
    parent:   parent
  }


  <span class="hljs-keyword">if</span>( _.isString( plugin ) ) {
    plugindesc.name = plugin
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isFunction( plugin ) ) {
    <span class="hljs-keyword">if</span>( _.isString(plugin.name) &amp;&amp; <span class="hljs-string">''</span> !== plugin.name ) {
      plugindesc.name = plugin.name
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> prefix = _.isArray(options.prefix) ? options.prefix[<span class="hljs-number">0</span>] : options.prefix
      plugindesc.name = prefix+nid()
    }

    plugindesc.init = plugin
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isObject( plugin ) ) {
    plugindesc = _.extend({},plugin,plugindesc)
    <span class="hljs-keyword">if</span>( !_.isString(plugindesc.name) ) <span class="hljs-keyword">throw</span> error(<span class="hljs-string">'no_name'</span>,plugin);
    <span class="hljs-keyword">if</span>( !_.isFunction(plugindesc.init) ) <span class="hljs-keyword">throw</span> error(<span class="hljs-string">'no_init_function'</span>,plugin);
  }
  
  plugindesc.options = _.extend(plugindesc.options||{},options||{})


  <span class="hljs-keyword">return</span> plugindesc
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h4 id="finds-the-plugin-module-using-require">Finds the plugin module using require</h4>
<p>The module must be a function.
Sets plugindesc.init to be the function exposed by the module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve_plugin</span><span class="hljs-params">( plugindesc, parent, options )</span> {</span>
  <span class="hljs-keyword">var</span> use_require = plugindesc.parent.require || parent.require


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">try_require</span><span class="hljs-params">(name)</span> {</span>
    <span class="hljs-keyword">var</span> first_err = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">var</span> found

    <span class="hljs-keyword">if</span>( !name ) <span class="hljs-keyword">return</span> found;

    <span class="hljs-keyword">try</span> {
      plugindesc.searched_paths.push(name)
      found = use_require(name)
      <span class="hljs-keyword">return</span> found
    }
    <span class="hljs-keyword">catch</span>(e) {
      first_err = first_err || e

      <span class="hljs-keyword">try</span> {
        found = parent.require(name)
      }
      <span class="hljs-keyword">catch</span>(ee) {
        first_err = first_err || ee
      }

      <span class="hljs-keyword">return</span> found;
    }
  }


  <span class="hljs-keyword">if</span>( !plugindesc.name ) {
    <span class="hljs-keyword">throw</span> error(<span class="hljs-string">'no_name'</span>,plugindesc)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Plugins can be tagged.
The tag can be embedded inside the name using a $ separator: <em>name$tag</em>.
Note: the $tag suffix is NOT considered part of the file name!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> m = <span class="hljs-regexp">/^(.+)\$(.+)$/</span>.exec(plugindesc.name)
  <span class="hljs-keyword">if</span>( m ) {
    plugindesc.name = m[<span class="hljs-number">1</span>]
    plugindesc.tag  = m[<span class="hljs-number">2</span>]
  }

  <span class="hljs-keyword">if</span>( !plugindesc.init) {
    plugindesc.searched_paths = []
    <span class="hljs-keyword">var</span> name = plugindesc.name
    <span class="hljs-keyword">var</span> tag  = plugindesc.tag
    <span class="hljs-keyword">var</span> fullname = name+(tag?<span class="hljs-string">'$'</span>+tag:<span class="hljs-string">''</span>)
    <span class="hljs-keyword">var</span> initfunc</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>try to load as a built-in module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span>( ~name.indexOf(<span class="hljs-string">'..'</span>) || ~name.indexOf(<span class="hljs-string">'/'</span>) ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>yes, control flow. I will burn in Hell.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"not a built-in: '"</span>+name+<span class="hljs-string">"', [SKIP]"</span>)
      }

      <span class="hljs-keyword">var</span> builtin_path = <span class="hljs-string">'../plugin/'</span>+name
      plugindesc.searched_paths.push(builtin_path)
      initfunc = parent.require(builtin_path)
    }

    <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">if</span>( e.message &amp;&amp; ( -<span class="hljs-number">1</span> != e.message.indexOf(<span class="hljs-string">"'"</span>+builtin_path+<span class="hljs-string">"'"</span>) || ~e.message.indexOf(<span class="hljs-string">'[SKIP]'</span>)) ) {

        <span class="hljs-keyword">var</span> plugin_names = [name]

        <span class="hljs-keyword">if</span>( _.isString( options.prefix ) ) {
          plugin_names.push( options.prefix+name )
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isArray( options.prefix ) ) {
          _.each( options.prefix, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prefix)</span> {</span>
            plugin_names.push( prefix+name )
          })        
        }

        plugin_names.push( <span class="hljs-string">'./'</span>+name )

        <span class="hljs-keyword">var</span> parent_filename = (plugindesc.parent||{}).filename
        <span class="hljs-keyword">var</span> paths = parent_filename ? [ path.dirname(parent_filename) ] : [] 
        paths = _.compact(paths.concat((plugindesc.parent||{}).paths||[]))

        <span class="hljs-keyword">var</span> plugin_paths = plugin_names.slice()
        paths.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span>{</span>
          plugin_names.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span>{</span>
            plugin_paths.push(path+<span class="hljs-string">'/'</span>+name)
          })
        })

        <span class="hljs-keyword">var</span> first_err
        <span class="hljs-keyword">do</span> {
          <span class="hljs-keyword">var</span> plugin_path = plugin_paths.shift()
          initfunc = try_require(plugin_path)
        }
        <span class="hljs-keyword">while</span>( _.isUndefined(initfunc) &amp;&amp; <span class="hljs-number">0</span> &lt; plugin_paths.length )
        <span class="hljs-keyword">if</span>( first_err ) <span class="hljs-keyword">throw</span> first_err;

      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> e;
    }


    <span class="hljs-keyword">if</span>( initfunc ) {
      <span class="hljs-keyword">if</span>( !_.isFunction(initfunc) ) {
        <span class="hljs-keyword">throw</span> error(<span class="hljs-string">'no_init_function'</span>,plugindesc)
      }

      plugindesc.init = initfunc
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> error(<span class="hljs-string">'not_found'</span>,plugindesc)
    }
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h4 id="export-the-make-function">Export the make function</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>module.exports = make</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
